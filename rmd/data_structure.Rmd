---
title: "Data Format, Structure, and Workflows"
author: "Maxim Grigri"
date: "May 3, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# General Data Format and Preparation

***

This document summarizes general formatting and preparation guidelines for all data
shared and uploaded to fortedata. It then provides a workflow for data to be uploaded 
to the shared forte google drive using the 'googledrive' R package.

## Naming files and folders

1. Names should be lowercase with "_" separating words.
2. File Type: CSV (Comma delimited)
3. Filenames: "data_type_year.csv" (i.e. "canopy_dendroband_2019.csv")
4. Folder Names: "data_type" (i.e. "canopy_dendroband")
5. Include EML approved word document metadata file in each folder
5. Each year should be 1 data file (but does this make sense for instrument data?)

## General File Structure and Format

1. Each row is one observation
2. Column names should:
  + Be lowercase with "_" separating words 
  + Include units if quantitative (i.e. "DBH_cm"; Flux units excluded)
  + Be documented in metadata (fortedata: added to `forte_table_metadata.csv`) 
3. Required columns:
  + Experimental unit id (i.e. plot/subplot)
  + **fortedata**: subplot_id -- replicate ("A-") plot ("-01-") subplot ("-E") (i.e   "A01E")
  + **SHOULD NOT** include separate replicate, plot, and subplot columns
  + date -- Date of data collection (YYYY-MM-DD)
  + notes

***

## Data Workflow: Field Data to fortedata 

Ideally all data products are properly formatted and structured from the start of 
data collection, but sometimes a few adjustments are needed to make your data more readable and match any required formatting. Here is an example "cleaning" script used to 
get subcanopy diameter data into proper format for the fortedata package. Most important here is the 1) Use of the 'googledrive' package to move smoothly from R to google drive, and 2) some examples of using base R for reformatting (Who ever uses base R!?). In the example of fortedata, there are a few steps you might have to take before using this code below.

1. Make sure that the 'fortedata' shared google drive folder is in "My Drive"
  + Click the dropdown menu next to "My Drive". If FoRTE is listed there, you can skip the following steps. If FoRTE is not there...
2. Click "Shared with me"" (assuming this folder was shared with you at some point) and locate the FoRTE shared folder.
3. Right click and select "Add Shortcut to Drive". Now you can access this shared folder from "My Drive" using the 'googledrive' R package.

```{r cleaning, include=TRUE, eval=FALSE}
# this script is an ingestion script for the subcanopy diameter data. In this example, 
# you can see I've used only base r to reduce dependencies with packages like dplyr

if (!require("googledrive")) {
  install.packages("googledrive")
}

# Bring in the desired csv's and make the format matching. Then upload them to 
# google drive 

sc_2020 <- read.csv("data/subcanopy_D_2020.csv", na.strings = c("", "NA"))

# since 2020 is more tidy, I will start there and then reformat 2019 to match it 
# First step will be to rename column names to match other fortedata products 

# seperate the uniqueID column into subplot and nested_subplot
# this creates a new nested_subplot column and creates a notes column to match 2019
# *see my data was kind of messy! My uniqueID column did not match fortedata requirements
#  and I was missing a notes column in 2020
sc_2020$nested_subplot <- substr(sc_2020$uniqueID, 5, 5)
sc_2020$notes <- "NA"

# this deletes the nested subplot ID from the uniqueID column leaving only the subplot_id
sc_2020$uniqueID <- gsub('.$', '', sc_2020$uniqueID)

# make all column names lowercase 
names(sc_2020) <- tolower(names(sc_2020))

# now rename columns to match other forte data products
names(sc_2020)[names(sc_2020) == "uniqueid"] <- "subplot_id"
names(sc_2020)[names(sc_2020) == "subplotid"] <- "subplot_id"

# now drop unwanted columns and reorder 
sc_2020 <- sc_2020[c("subplot_id", "nested_subplot", "tag", "species", "dbh_mm", 
                     "date", "notes")]

# change 2020 to have same data classes for each vector; data classes 
# for variables already in fortedata metadata should conform to established classes 

# change 2020 nested to int, 2020 and 2019 date to date, 2020 notes to character
sc_2020$nested_subplot <- as.integer(sc_2020$nested_subplot)
sc_2020$date <- as.Date(sc_2020$date, "%Y-%m-%d")

#####################################################################################
# alright now they are properly formated and ready to go onto fortedata. 
# upload to google drive 

# first, write csv's. These will save in your 'data' folder and then you will upload
# them to google drive. Unfortunately there is not a way (that I know of...) to move
# directly from an R dataframe to google drive, so we need this intermediate step.
# Make sure to name them something different than the original files. In the case of 
# fortedata, use 'fd' at the start to signify it's ready to go to the package
write.csv(sc_2020, "data/fd_subcanopy_diameter_2020.csv", row.names = FALSE)

# find the folder pathway on mydrive and assign it to an object, in this case I called
# it 'y'
x <- drive_find(type = "folder", pattern = "subcanopy_diameter", n_max = 6)
y <- x[[1,2]]

# now upload using the file id we located above 
drive_upload(
  "data/fd_subcanopy_diameter_2020.csv", # this is the name of the file on your machine 
  name = "fd_subcanopy_diameter_2020", # this is the name of the file on googledrive
  path = as_id(y), # this identifies the path to which you've assigned the letter 'y'
  overwrite = TRUE # this overwrites a file with the same name in the googledrive
)

```